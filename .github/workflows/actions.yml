name: Moltbook Actions

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Pilih aksi yang ingin dilakukan'
        required: true
        type: choice
        options:
          - check_status
          - view_feed
          - create_post
          - view_profile
      post_title:
        description: 'Judul post (untuk create_post)'
        required: false
      post_content:
        description: 'Isi post (untuk create_post)'
        required: false

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Execute Action
        env:
          API_KEY: ${{ secrets.MOLTBOOK_API_KEY }}
        run: |
          ACTION="${{ github.event.inputs.action }}"
          
          if [ -z "$API_KEY" ]; then
            echo "‚ùå ERROR: API Key tidak ditemukan!"
            echo "Silakan simpan API key di GitHub Secrets dengan nama: MOLTBOOK_API_KEY"
            exit 1
          fi
          
          echo "üîß Menjalankan aksi: $ACTION"
          echo ""
          
          if [ "$ACTION" == "check_status" ]; then
            echo "üîç Mengecek status agent..."
            curl -s https://www.moltbook.com/api/v1/agents/status \
              -H "Authorization: Bearer $API_KEY" | jq '.'
          
          elif [ "$ACTION" == "view_feed" ]; then
            echo "üì∞ Feed terbaru (10 posts):"
            curl -s "https://www.moltbook.com/api/v1/feed?sort=new&limit=10" \
              -H "Authorization: Bearer $API_KEY" | \
              jq '.posts[] | "[\(.submolt)] \(.title) by @\(.author.name) ‚Üë\(.upvotes)"'
          
          elif [ "$ACTION" == "create_post" ]; then
            TITLE="${{ github.event.inputs.post_title }}"
            CONTENT="${{ github.event.inputs.post_content }}"
            
            if [ -z "$TITLE" ]; then
              echo "‚ùå Error: Judul post tidak boleh kosong"
              exit 1
            fi
            
            echo "‚úçÔ∏è  Membuat post baru..."
            curl -s -X POST https://www.moltbook.com/api/v1/posts \
              -H "Authorization: Bearer $API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"submolt\": \"general\", \"title\": \"$TITLE\", \"content\": \"$CONTENT\"}" | jq '.'
          
          elif [ "$ACTION" == "view_profile" ]; then
            echo "üë§ Profile Anda:"
            curl -s https://www.moltbook.com/api/v1/agents/me \
              -H "Authorization: Bearer $API_KEY" | \
              jq '{name, description, karma, followers: .follower_count, following: .following_count, status}'
          fi
