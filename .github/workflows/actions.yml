name: Moltbook Actions Fixed

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Pilih aksi yang ingin dilakukan'
        required: true
        type: choice
        options:
          - check_status
          - view_feed
          - create_post
          - view_profile
      submolt:
        description: 'Submolt (untuk create_post)'
        required: false
        default: 'general'
      post_title:
        description: 'Judul post (untuk create_post)'
        required: false
      post_content:
        description: 'Isi post (untuk create_post)'
        required: false

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Execute Action
        env:
          API_KEY: ${{ secrets.MOLTBOOK_API_KEY }}
        run: |
          ACTION="${{ github.event.inputs.action }}"
          
          if [ -z "$API_KEY" ]; then
            echo "‚ùå ERROR: API Key tidak ditemukan!"
            exit 1
          fi
          
          echo "üîß Menjalankan aksi: $ACTION"
          echo ""
          
          if [ "$ACTION" == "check_status" ]; then
            echo "üîç Mengecek status agent..."
            curl -s https://www.moltbook.com/api/v1/agents/status \
              -H "Authorization: Bearer $API_KEY" | jq '.'
          
          elif [ "$ACTION" == "view_feed" ]; then
            echo "üì∞ Feed terbaru (10 posts):"
            curl -s "https://www.moltbook.com/api/v1/feed?sort=new&limit=10" \
              -H "Authorization: Bearer $API_KEY" | jq '.'
          
          elif [ "$ACTION" == "create_post" ]; then
            TITLE="${{ github.event.inputs.post_title }}"
            CONTENT="${{ github.event.inputs.post_content }}"
            SUBMOLT="${{ github.event.inputs.submolt }}"
            
            if [ -z "$TITLE" ]; then
              echo "‚ùå Error: Judul post tidak boleh kosong"
              exit 1
            fi
            
            if [ -z "$SUBMOLT" ]; then
              SUBMOLT="general"
            fi
            
            echo "‚úçÔ∏è Membuat post baru di m/$SUBMOLT..."
            curl -s -X POST https://www.moltbook.com/api/v1/posts \
              -H "Authorization: Bearer $API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"submolt\": \"$SUBMOLT\", \"title\": \"$TITLE\", \"content\": \"$CONTENT\"}" | jq '.'
          
          elif [ "$ACTION" == "view_profile" ]; then
            echo "üë§ Mengambil profile lengkap..."
            
            # Get full response
            RESPONSE=$(curl -s https://www.moltbook.com/api/v1/agents/me \
              -H "Authorization: Bearer $API_KEY")
            
            echo "üì• Full Response:"
            echo "$RESPONSE" | jq '.'
            
            echo ""
            echo "üìä Parsed Profile Info:"
            
            # Try to parse specific fields
            NAME=$(echo "$RESPONSE" | jq -r '.agent.name // .name // "N/A"')
            DESC=$(echo "$RESPONSE" | jq -r '.agent.description // .description // "N/A"')
            KARMA=$(echo "$RESPONSE" | jq -r '.agent.karma // .karma // "0"')
            FOLLOWERS=$(echo "$RESPONSE" | jq -r '.agent.follower_count // .follower_count // "0"')
            FOLLOWING=$(echo "$RESPONSE" | jq -r '.agent.following_count // .following_count // "0"')
            STATUS=$(echo "$RESPONSE" | jq -r '.agent.status // .status // "N/A"')
            
            echo "Name: $NAME"
            echo "Description: $DESC"
            echo "Karma: $KARMA"
            echo "Followers: $FOLLOWERS"
            echo "Following: $FOLLOWING"
            echo "Status: $STATUS"
          fi
